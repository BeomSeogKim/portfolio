# :pushpin: 삼삼오오(3355)
>같은 관심사를 가진 사람들을 모으고 소통할 수 있도록 돕는 소모임 커뮤니티  
>https://3355.world

</br>

## 1. 제작 기간 & 참여 인원
- 2022년 9월 16일 ~ 10월 28일
- 팀 프로젝트
  - [FrontEnd] : 김고은(부 팀장), 이경하, 이혜림
  - [BackEnd]  : 김범석(팀장), 김하영 

</br>

## 2. 사용 기술
#### `Backend`
  - Java 11
  - Spring Boot 2.7.3
  - Gradle 7.5
  - Spring Data JPA
  - QueryDSL 1.0.10
  - H2 1.4.200
  - MySQL 8.0.28
  - Spring Security
  - WebSocket
  - Junit5
  - Jmeter

</br>

## 3. ERD 설계
![image](https://user-images.githubusercontent.com/110332047/197563865-388aeeb3-2854-41c0-842b-200f174903c8.png)

</br>

## 4. 핵심 기능 
- 4.1 모임 게시글 작성
  - 모임 게시글 작성시 카테고리를 정할 수 있습니다.(운동 / 여행 / 독서 / 공부/ 종교 / 온라인 / 기타)
  - 모임 게시글 작성시 이미지를 업로드하지 않을 경우 카테고리에서 기본 제공하는 이미지로 업로드가 가능합니다.
- 4.2 실시간 알림 기능 
  - SSE를 활용하여 실시간 알림 구현 
  - 모임 게시글 신청 시 게시글 작성자에게 알림 송신
  - 게시글 댓글 작성 시 게시글 작성자에게 알림 송신
  - 모임 신청 승인 / 거절 시 지원자에게 알림 송신
  - 채팅방에 새로운 채팅 존재 시 채팅방 멤버들에게 알림 송신 
- 4.3 채팅 기능
  - WebSocket을 활용하여 채팅 구현 
  - Stomp를 활용한 pub/sub 구현 
  - 모임 생성 시 채팅방이 자동적으로 열림
  - 채팅방 목록에서 내가 읽지 않은 메세지의 갯수 확인 가능 
- 4.4 신고 기능 
  - 게시글, 댓글, 회원에 대하여 신고 가능
  - 각 신고 건에 대해서는 관리자가 확인 후 처리 
  - 신고당한 게시글 및 댓글의 경우 제재처리를 당하면 해당 서비스에서 확인 할 수 없음
  - 누적 신고제를 적용하여 제재 당한 횟수가 10회 이상일 경우 회원 제재
  - 제재된 회원은 별도의 조치가 있을때 까지 해당 서비스 이용 불가
- 4.5 검색 기능 
  - 검색의 경우 Category, keyword로 검색 가능 
  - 두가지 조건 중 한가지만 존재해도 검색 가능 
  - keyword의 경우 제목, 내용, 주소에 대해 검색 가능

## 5. 트러블 슈팅
- 5.1 회원 탈퇴
  - 도입 이유 
      - 회원이 탈퇴할 때 서비스에서 보여지는 회원의 개인 정보를 숨기기 위해 도입
  - 문제 발생 
      - 회원이 탈퇴할 경우 회원과 관련된 활동들이 삭제되어야 하는 상황 발생
      - 이로 인해 다른 사람들의 활동 지표가 떨어지는 현상 발생 
  - 문제 원인 
      - 객체들간의 연관관계로 인하여 회원만 삭제 할 수 없음
  - 선택지
      1. 각 데이터들의 연관 관계를 끊어 서비스를 운영
      2. 회원 정보를 영구적으로 바꾸어 서비스를 운영
      3. 회원 탈퇴 관련 Table을 하나 더 생성해 서비스를 관리
  - 의견 결정 
      - 유연한 객체 지향 프로그래밍을 위해서는 연관관계를 맺는 것이 좋다고 판단
      - 회원 탈퇴 시 재가입의 경우를 고려해 일정기간동안 정보를 보관해야 한다고 판단.
      - **회원 탈퇴 시 중요한 일부 정보는 다른 Table에 보관하고 Member Table에는 중요 정보 삭제**
      - **Scheduler를 사용해 탈퇴한 지 5년이 지난 회원의 경우 자동적으로 회원 정보를 삭제**
- 5.2 회원 신고
   - 도입 이유
      - 커뮤니티 플랫폼 특성상 광고성 게시글 및 댓글에 취약함
      - 커뮤니티 플랫폼 특성상 부적절한게시글 및 댓글에 취약함
      - 이에 따라 신고기능이 필요하여 도입
      - 신고의 경우 댓글, 게시글, 회원에 대해 신고 가능
   - 문제 발생
      - 게시글 및 댓글에 대해서는 정상적으로 제재가 가능함 
      - 회원의 경우 신고 처리 시 바로 활동을 못하도록 제재를 해야 하는 상황 발생
   - 문제 원인 
      - 신고 접수 처리시 상태 변경하는 로직만 존재 
   - 선택지 
      1. 회원 신고 처리시 회원을 바로 제재함
      2. 회원 관련하여 신고를 하지 않음
      3. 누적 신고를 적용해 누적 신고 횟수가 일정 숫자를 넘을 경우 제재를 가함
   - 의견 결정 
     - 회원 신고 처리시 회원을 바로 제재하는 것은 너무 강압적인 방법
     - 악성 회원에 대해서는 제재 처리가 필요함 
     - 게시글, 댓글 및 회원 신고에 대해 누적 신고제를 도입
     - 총 10회 제재를 당하게 되면 회원의 활동이 금지됨
 - 5.3 채팅 메세지 읽은 횟수
   - 도입 이유
     - 유저피드백에서 몇개의 메세지를 읽지 않았는지 알 수 있으면 좋겠다는 피드백 반영
   - 문제 발생 
     - 회원들이 실시간 채팅에 참여하고 있을때 실제 읽은 회원보다 한개 더 count 되는 현상 확인
   - 문제 원인
     - 메세지를 송부할 경우 메세지를 읽은 회원을 체크하기 위한 ReadCheck 엔티티에 데이터를 추가하지 않음
   - 문제 해결
     - 메세지를 송부할 경우 ReadCheck 엔티티에 값을 기입해주어 정상 작동 해결
 - 5.4 No Session 
   - 문제 발생 
     - 같은 post인지 비교하는 도중 No Session Error 발생 
   - 문제 원인
     - Entity 연관관계 설정에서 Member와 Post 관계에서 Lazy Loading 설정이 되어 있음
     - Lazy Loading이 설정되어 있을경우 해당 Entity를 직접 꺼내지 않는다면 Proxy 객체 반환 
     - Proxy 객체와 객체를 비교할 수 없어 문제 발생
   - 해결 방안 
     - 같은 세션을 유지하기 위해 @Transactional 을 사용하여 해결
 - 5.5 Hikari Pool
   - 문제 발생
     - 실시간 알림을 구현한 후로 서버에 배포하였을 때 배포한 지 얼마 지나지 않아 서버 전반적으로 데이터들이 조회가 안되는 현상 발생
   - 문제 원인
     - Client가 구독을 할 때 마다 Hikari Connection Pool( 이하 CP)을 사용하고 반납을 하지 않음
     - 이로 인해 다른 요청들이 CP를 받지 못하고 기다리다가 시간 초과로 인해 문제 발생
   - 해결 방안 
     1. 1차 해결 방안 
       - HikariConnection PoolSize 를 30으로 늘려줌 
     2. 2차 해결 방안 
       - Open Session In View 설정을 off설정
  - 5.6 Nginx
    - 도입 이유
      - 무중단 배포 및 https 적용 및 비용의 효율성으로 인해 도입
    - 문제 발생 
      - WebSocket, ServerSentEvent가 동작하지 않는 현상 발생   
    - 문제 원인 
      - 웹소켓
        - 문제 원인 
          - 웹소켓의 경우 response로 status code 101 (switching protocol)를 반환해야 하지만 200 OK 가 전달됨
        - 선택지
          1. 웹소켓을 선택하기 전으로 서버를 되돌림
          2. Nginx 추가 설정을 하여 통신을 할 수 있도록 해결함
        - 의견 결정 
          - Nginx를 적용한 후로 안정적인 서버 운영이 가능해졌음
          - Nginx를 적용한 후로 비교적 쉽게 https 적용이 가능
          - Nginx로 인한 이점이 더 많아 nginx.conf 설정을 변경하여 사용할 수 있도록 결정
      - SSE(Server-Sent-Event)
        - 문제 원인
          - Nginx는 기본적으로 Upstream으로 요청을 보낼 때 Http/1.0 버전을 사용
          - Http/1.1의 경우 지속 연결이 기본이기에 헤더를 따로 설정할 필요가 없지만
          - Nginx에서 백엔드의 WAS로 요청을 보낼 때에는 HTTP/1.0을 사용하고 Connection:close 헤더를 사용함
          - 이로 인해 지속 연결을 계속 닫아 SSE 가 정상적으로 작동하지 않음
        - 선택지
          - 웹소켓을 선택하기 전으로 서버를 되돌리기
          - Nginx 추가 설정을 하여 SSE를 사용
        - 의견 결정
          - Nginx 를 적용한 후로 안정적인 서버 운영이 가능해졌음
          - Nginx를 적용한 후로 비교적 쉽게 https 적용이 가능
          - Nginx로 인한 이점이 더 많아 nginx.conf 설정을 변경하여 사용할 수 있도록 결정


## 6. 기능 개선 사항 
